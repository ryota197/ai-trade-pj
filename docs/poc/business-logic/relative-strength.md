# Relative Strength（相対強度）算出ロジック

## 概要

RS Rating（相対強度レーティング）は、**William O'Neil**が創設した**IBD（Investor's Business Daily）**で使用される株式評価指標。個別銘柄の価格パフォーマンスをS&P500と比較し、全銘柄中でのパーセンタイルランキング（1-99）として表す。

**CAN-SLIMの「L（Leader）」** に該当し、市場をリードする強い銘柄を見つけるために使用される。

---

## 用語定義

| 用語 | 定義 | 値の範囲 |
|------|------|----------|
| **加重パフォーマンス** | 4期間のリターンを加重平均した値 | -∞〜+∞ (%) |
| **Relative Strength（相対強度）** | 銘柄の加重パフォーマンス ÷ ベンチマークの加重パフォーマンス | 0〜∞ |
| **RS Rating** | 全銘柄中のパーセンタイル順位 | 1〜99 |

---

## 対象銘柄（Stock Universe）

RS Rating のパーセンタイル計算において、**どの銘柄を母集団とするか** は重要な設計判断である。

### IBD公式の母集団

| 項目 | 内容 |
|------|------|
| 対象 | IBDデータベース内の全銘柄（2,700社以上） |
| 比較 | S&P500だけでなく、全追跡銘柄と比較 |
| 更新 | 日次更新 |

> RS Rating 99 = 過去12ヶ月で **全銘柄の99%** を上回るパフォーマンス

### 本システムの対象銘柄

#### 包含条件（Include）

| 条件 | 理由 |
|------|------|
| `relative_strength` が計算済み | パーセンタイル計算に必要 |
| 12ヶ月（252営業日）以上の価格履歴 | IBD式計算の前提条件 |
| 追跡対象として登録済み（stocksテーブル） | 母集団の一貫性 |

#### 除外条件（Exclude）

| 条件 | 理由 |
|------|------|
| ETF・指数 | 個別株のランキングが目的 |
| 価格履歴が12ヶ月未満 | 計算不可（IPO直後等） |
| 株式分割直後（未調整データ） | 計算結果が不正確になる |
| 上場廃止・取引停止銘柄 | 投資対象外 |

#### データ鮮度の考慮

```
【推奨】各銘柄の「最新の relative_strength」を使用

理由:
- Job 1 で一部銘柄のみ更新した場合も、全銘柄でランキング可能
- RS Rating 80 = 「上位20%」の意味を維持
- 母集団サイズの一貫性を確保

【非推奨】当日更新分のみを対象

問題:
- 100銘柄だけ更新 → 100銘柄中のランキングになる
- RS Rating の意味が日によって変わる
```

### PoC実装での簡略化

| 項目 | IBD公式 | PoC実装 |
|------|---------|---------|
| 母集団サイズ | 2,700社以上 | S&P500（約500社） |
| 更新頻度 | 日次 | 日次（バッチ） |
| データソース | 独自データベース | yfinance API |

**注意**: 母集団が小さいほど、RS Rating の精度は低下する。500銘柄でも実用的だが、IBD公式とは異なる値になる。

---

## IBD式 計算フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                    RS Rating 計算フロー（IBD式）                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Step 1: 4期間のリターン計算                                     │
│  ─────────────────────────                                      │
│    3ヶ月リターン  (63営業日)                                     │
│    6ヶ月リターン  (126営業日)                                    │
│    9ヶ月リターン  (189営業日)                                    │
│    12ヶ月リターン (252営業日)                                    │
│                                                                 │
│  Step 2: 加重パフォーマンス計算                                   │
│  ─────────────────────────                                      │
│    加重パフォーマンス = 3ヶ月 × 40%                              │
│                       + 6ヶ月 × 20%                              │
│                       + 9ヶ月 × 20%                              │
│                       + 12ヶ月 × 20%                             │
│                                                                 │
│    ※ 直近3ヶ月を2倍に重み付け（モメンタム重視）                   │
│                                                                 │
│  Step 3: 相対強度計算                                            │
│  ─────────────────────────                                      │
│    銘柄・S&P500 それぞれの加重パフォーマンスを計算                │
│    Relative Strength = 銘柄 / S&P500 × 100                      │
│                                                                 │
│  Step 4: パーセンタイルランク                                     │
│  ─────────────────────────                                      │
│    全銘柄の相対強度でランキング                                   │
│    RS Rating = パーセンタイル順位 (1-99)                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Step 1: 期間リターン計算

### 計算式

```
期間リターン(%) = (現在価格 - N日前価格) / N日前価格 × 100
```

### 期間と営業日数

| 期間 | 営業日数 | 加重 |
|------|----------|------|
| 3ヶ月 | 63日 | 40%（2倍） |
| 6ヶ月 | 126日 | 20% |
| 9ヶ月 | 189日 | 20% |
| 12ヶ月 | 252日 | 20% |

### 例

```
NVDA の各期間リターン:
  3ヶ月リターン:  +25%
  6ヶ月リターン:  +40%
  9ヶ月リターン:  +60%
  12ヶ月リターン: +80%
```

---

## Step 2: 加重パフォーマンス計算

### IBD式 加重平均

```
加重パフォーマンス = (3ヶ月 × 0.40) + (6ヶ月 × 0.20) + (9ヶ月 × 0.20) + (12ヶ月 × 0.20)
```

**なぜ直近3ヶ月を2倍に重み付けするか？**
- モメンタム投資の原則：「強い株はより強くなる」
- 直近のトレンドが将来のパフォーマンスを予測する可能性が高い
- 古い情報より新しい情報の方が市場の現状を反映

### 例

```
NVDA の加重パフォーマンス:
  = (25 × 0.40) + (40 × 0.20) + (60 × 0.20) + (80 × 0.20)
  = 10 + 8 + 12 + 16
  = 46%

S&P500 の加重パフォーマンス:
  3ヶ月: +5%, 6ヶ月: +8%, 9ヶ月: +10%, 12ヶ月: +12%
  = (5 × 0.40) + (8 × 0.20) + (10 × 0.20) + (12 × 0.20)
  = 2 + 1.6 + 2 + 2.4
  = 8%
```

---

## Step 3: 相対強度計算

### 計算式

```
Relative Strength = (1 + 銘柄加重パフォーマンス/100) / (1 + ベンチマーク加重パフォーマンス/100) × 100
```

または簡易版:
```
Relative Strength = 銘柄加重パフォーマンス / ベンチマーク加重パフォーマンス × 100
```

### 例

```
NVDA の Relative Strength:
  = (1 + 46/100) / (1 + 8/100) × 100
  = 1.46 / 1.08 × 100
  = 135.2

解釈: NVDA は S&P500 の約1.35倍のパフォーマンス
```

### 解釈

| 相対強度 | 意味 |
|----------|------|
| 100 | S&P500と同等 |
| >100 | S&P500をアウトパフォーム |
| <100 | S&P500をアンダーパフォーム |

---

## Step 4: RS Rating 計算（パーセンタイル）

### 手順

1. 全銘柄の Relative Strength を計算
2. 昇順にソート
3. 各銘柄のパーセンタイル順位を計算
4. 1〜99 の範囲に収める

### 計算式

```
RS Rating = (その銘柄より弱い銘柄数 / 全銘柄数) × 100
```

### 例

```
全500銘柄中、NVDA の相対強度が 480位（上から20番目）の場合:
  RS Rating = (480 / 500) × 100 = 96

解釈: 上位4% のパフォーマンス
```

---

## CAN-SLIM 基準

| RS Rating | 判定 | 説明 |
|-----------|------|------|
| ≥ 90 | 優良 | 上位10%、真の主導株 |
| ≥ 80 | 合格 | 上位20%、CAN-SLIM推奨水準 |
| 70〜79 | 要注意 | 境界線上 |
| < 70 | 不合格 | 市場平均以下、見送り |

---

## エッジケース

### ベンチマーク加重パフォーマンスが 0 または負の場合

```
ケース1: ベンチマーク = 0
  → Relative Strength = 計算不可（NULL）

ケース2: ベンチマーク < 0（下落相場）
  銘柄 = +10%, ベンチマーク = -5%
  RS = (1 + 0.10) / (1 - 0.05) × 100 = 1.10 / 0.95 × 100 = 115.8

  → 正の値として計算可能
  → 下落相場でプラスを維持する銘柄は相対的に強い
```

### データ不足

- 最低12ヶ月（252営業日）のデータが必要
- IPO直後の銘柄は RS Rating = 1 を割り当て

---

## 注意点

1. **ラグ（遅延）**: 過去データに基づくため、急激な変化には追いつかない
2. **セクターバイアス**: 特定セクターが強い時期は、そのセクター全体の RS が高くなる
3. **単独指標としての限界**: CAN-SLIM の他の要素と組み合わせて判断

---

## 参考文献

- ウィリアム・オニール『オニールの成長株発掘法』
- [IBD RS Rating 公式説明](https://www.investors.com/how-to-invest/investors-corner/relative-strength-rating-stock-chart-analysis-helps-pick-outstanding-growth-stocks/)
- [GitHub - IBD Style Relative Strength](https://github.com/skyte/relative-strength)
- [TradingView - Relative Strength (IBD Style)](https://www.tradingview.com/script/SHE1xOMC-Relative-Strength-IBD-Style/)
