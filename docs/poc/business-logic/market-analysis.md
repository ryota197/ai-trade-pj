# マーケット状態判定ロジック

## 概要

CAN-SLIM投資手法における「M（Market Direction）」の判断材料を提供する。
市場全体の環境を分析し、Risk On / Risk Off / Neutral の3状態に分類する。

---

## 判定の目的

| 状態 | 意味 | 投資行動 |
|------|------|----------|
| **Risk On** | 市場環境が良好 | 新規エントリーを積極的に検討 |
| **Risk Off** | 市場環境が悪化 | 新規エントリーを控え、ポジション縮小を検討 |
| **Neutral** | 市場環境が中立 | 個別銘柄の選別が重要、慎重にエントリー |

---

## 使用する指標

### 1. VIX（恐怖指数）

**概要**: S&P500オプションのインプライドボラティリティ。市場の恐怖心を表す。

| 条件 | 判定 | スコア | 根拠 |
|------|------|--------|------|
| VIX < 20 | Bullish | +2 | 市場が安定しており、リスクオンの環境 |
| 20 ≤ VIX ≤ 30 | Neutral | 0 | 通常の範囲 |
| VIX > 30 | Bearish | -2 | 市場が不安定、リスク回避ムード |

**重み**: ±2（最も重要な指標として重み付け）

**データソース**: `^VIX` (yfinance)

---

### 2. S&P500 RSI（相対力指数）

**概要**: S&P500の14日RSI。買われすぎ/売られすぎを判定。

| 条件 | 判定 | スコア | 根拠 |
|------|------|--------|------|
| 30 ≤ RSI ≤ 70 | Bullish | +1 | 健全なトレンド範囲 |
| RSI < 30 | Bearish | -1 | 売られすぎ（下落トレンド継続の可能性） |
| RSI > 70 | Bearish | -1 | 買われすぎ（調整リスク） |

**注意**: RSI < 30 は逆張りの買いシグナルとも解釈できるが、本システムでは「市場環境の判定」が目的のため、下落トレンドの継続リスクとして Bearish 判定とする。

**データソース**: `^GSPC` の価格履歴から計算

---

### 3. S&P500 vs 200日移動平均

**概要**: S&P500が200日移動平均を上回っているか。長期トレンドの判定。

| 条件 | 判定 | スコア | 根拠 |
|------|------|--------|------|
| 現在価格 > 200MA | Bullish | +1 | 長期上昇トレンド |
| 現在価格 ≤ 200MA | Bearish | -1 | 長期下降トレンドまたはトレンド転換 |

**根拠**: 200MAは機関投資家が重視する指標。多くのファンドが200MA割れで売却ルールを持つ。

**データソース**: `^GSPC` の200日分の価格履歴から計算

---

### 4. Put/Call Ratio

**概要**: プットオプションとコールオプションの出来高比率。市場のセンチメントを表す。

| 条件 | 判定 | スコア | 根拠 |
|------|------|--------|------|
| P/C > 1.0 | Bullish | +1 | 悲観的センチメント → 逆張りで強気シグナル |
| 0.7 ≤ P/C ≤ 1.0 | Neutral | 0 | 通常の範囲 |
| P/C < 0.7 | Bearish | -1 | 楽観的センチメント → 過熱警戒 |

**根拠**: 逆張り指標として使用。極端な悲観は底打ちのサイン、極端な楽観は天井のサイン。

**データソース**: CBOE Put/Call Ratio（yfinanceでは直接取得困難なため、代替データまたはデフォルト値を使用）

---

## スコア計算

### 合計スコアの範囲

```
最大スコア: +5 (VIX:+2, RSI:+1, MA:+1, P/C:+1)
最小スコア: -5 (VIX:-2, RSI:-1, MA:-1, P/C:-1)
```

### 判定閾値

| 条件 | 判定 |
|------|------|
| スコア ≥ 3 | **Risk On** |
| スコア ≤ -2 | **Risk Off** |
| -2 < スコア < 3 | **Neutral** |

**閾値の設計意図**:
- Risk On は高い確信が必要（3/5以上の指標が強気）
- Risk Off は早めに警戒（-2で発動、2/5の指標が弱気で十分）
- 非対称にすることで、損失回避を優先

---

## 確信度（Confidence）

判定の確信度を0.0〜1.0で表す。

### 計算ロジック

```python
if condition == NEUTRAL:
    confidence = 0.5

elif condition == RISK_ON:
    # スコア3で0.6、スコア5で1.0
    confidence = 0.6 + (score - 3) / (5 - 3) * 0.4

elif condition == RISK_OFF:
    # スコア-2で0.6、スコア-5で1.0
    confidence = 0.6 + (abs(score) - 2) / (5 - 2) * 0.4
```

### 確信度レベル

| 確信度 | レベル | 推奨アクション強度 |
|--------|--------|-------------------|
| 0.8 - 1.0 | 高 | 強い推奨 |
| 0.6 - 0.8 | 中 | 通常の推奨 |
| 0.5 - 0.6 | 低 | 弱い推奨 |

---

## 推奨アクションテキスト

### Risk On

| 確信度 | テキスト |
|--------|----------|
| 高 | 市場環境は良好。個別株のエントリーを積極的に検討可。 |
| 中 | 市場環境は良好。個別株のエントリー検討可。 |
| 低 | 市場環境はやや良好。慎重にエントリーを検討。 |

### Risk Off

| 確信度 | テキスト |
|--------|----------|
| 高 | 市場環境は悪化。新規エントリーは避け、ポジション縮小を検討。 |
| 中 | 市場環境は不安定。新規エントリーは控えめに。 |
| 低 | 市場環境はやや不安定。リスク管理を徹底。 |

### Neutral

| 確信度 | テキスト |
|--------|----------|
| - | 市場環境は中立。個別銘柄の選別が重要。 |

---

## エッジケース

### データ取得失敗時

| 指標 | フォールバック |
|------|---------------|
| VIX | 20（中立値）を使用 |
| RSI | 50（中立値）を使用 |
| 200MA | 計算不可の場合、現在価格と同値（中立） |
| P/C Ratio | 0.85（中立値）を使用 |

### 市場休場時

- 直近の取引日のデータを使用
- `analyzed_at` に実際の分析日時を記録

---

## 実装コード参照

- Entity: `backend/src/domain/entities/market_status.py`
- Value Object: `backend/src/domain/value_objects/market_indicators.py`
- Domain Service: `backend/src/domain/services/market_analyzer.py`
- Repository Interface: `backend/src/domain/repositories/market_data_repository.py`

---

## 将来の拡張案

1. **指標の追加**
   - 騰落レシオ（Advance/Decline Ratio）
   - 新高値/新安値銘柄数
   - セクターローテーション分析

2. **重み付けの動的調整**
   - 市場状況に応じた指標の重み変更
   - 機械学習による最適化

3. **時系列分析**
   - 状態遷移パターンの記録
   - トレンド転換の早期検知
